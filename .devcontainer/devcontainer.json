# ğŸ“ˆ CÃ´ng cá»¥ PhÃ¢n TÃ­ch Ká»¹ Thuáº­t Chá»©ng KhoÃ¡n VN báº±ng Finnhub

import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import requests
import datetime

# ====================== Cáº¤U HÃŒNH API ======================
st.set_page_config(page_title="PhÃ¢n TÃ­ch Cá»• Phiáº¿u VN", layout="wide")
st.title("ğŸ“Š PhÃ¢n TÃ­ch Ká»¹ Thuáº­t Chá»©ng KhoÃ¡n VN (Finnhub API)")

API_KEY = st.secrets["finnhub_api_key"] if "finnhub_api_key" in st.secrets else st.text_input("ğŸ”‘ Nháº­p API Key Finnhub:")

# ====================== HÃ€M Láº¤Y Dá»® LIá»†U ======================
def get_data_finnhub(symbol: str, days: int = 120):
    end = int(datetime.datetime.now().timestamp())
    start = int((datetime.datetime.now() - datetime.timedelta(days=days)).timestamp())
    url = f"https://finnhub.io/api/v1/stock/candle?symbol={symbol}&resolution=D&from={start}&to={end}&token={API_KEY}"
    res = requests.get(url, timeout=10)
    data = res.json()
    if data.get("s") != "ok":
        return None
    df = pd.DataFrame({
        "date": pd.to_datetime(np.array(data["t"], dtype='datetime64[s]')),
        "open": data["o"],
        "high": data["h"],
        "low": data["l"],
        "close": data["c"],
        "volume": data["v"]
    })
    df.set_index("date", inplace=True)
    return df

# ====================== CHá»ˆ BÃO ======================
def calculate_indicators(df):
    df['EMA20'] = df['close'].ewm(span=20).mean()
    df['EMA50'] = df['close'].ewm(span=50).mean()
    delta = df['close'].diff()
    gain = delta.where(delta > 0, 0).rolling(14).mean()
    loss = -delta.where(delta < 0, 0).rolling(14).mean()
    rs = gain / loss
    df['RSI'] = 100 - (100 / (1 + rs))
    df['MACD'] = df['close'].ewm(12).mean() - df['close'].ewm(26).mean()
    df['Signal'] = df['MACD'].ewm(9).mean()
    return df

# ====================== TÃN HIá»†U ======================
def generate_signals(df):
    df['Buy'] = np.where(
        (df['EMA20'] > df['EMA50']) &
        (df['EMA20'].shift(1) <= df['EMA50'].shift(1)) &
        (df['MACD'] > df['Signal']) &
        (df['RSI'] > 30) & (df['RSI'] < 70),
        df['close'],
        np.nan
    )
    df['Sell'] = np.where(
        (df['EMA20'] < df['EMA50']) &
        (df['EMA20'].shift(1) >= df['EMA50'].shift(1)),
        df['close'],
        np.nan
    )
    return df

# ====================== Váº¼ BIá»‚U Äá»’ ======================
def plot_chart(df, symbol):
    fig, ax = plt.subplots(figsize=(14, 6))
    ax.plot(df.index, df['close'], label='Close', color='black')
    ax.plot(df.index, df['EMA20'], label='EMA20', color='blue')
    ax.plot(df.index, df['EMA50'], label='EMA50', color='red')
    ax.scatter(df.index, df['Buy'], marker='^', color='green', label='Buy', s=100)
    ax.scatter(df.index, df['Sell'], marker='v', color='red', label='Sell', s=100)
    ax.set_title(f"Biá»ƒu Ä‘á»“ giÃ¡ vÃ  tÃ­n hiá»‡u: {symbol}")
    ax.legend()
    ax.grid(True)
    st.pyplot(fig)

# ====================== GIAO DIá»†N STREAMLIT ======================
symbol = st.text_input("ğŸ“¥ Nháº­p mÃ£ cá»• phiáº¿u Finnhub (VD: VNM.VN, FPT.VN):", "FPT.VN").upper()

if API_KEY and symbol:
    with st.spinner("ğŸ“¡ Äang táº£i dá»¯ liá»‡u..."):
        df = get_data_finnhub(symbol)
    if df is not None:
        df = calculate_indicators(df)
        df = generate_signals(df)
        st.subheader("ğŸ“ˆ Biá»ƒu Ä‘á»“ ká»¹ thuáº­t")
        plot_chart(df, symbol)

        st.subheader("ğŸ“Š Chá»‰ bÃ¡o má»›i nháº¥t:")
        st.write(df[['close', 'EMA20', 'EMA50', 'MACD', 'Signal', 'RSI']].tail(1).T)

        last = df.iloc[-1]
        if not np.isnan(last['Buy']):
            st.success(f"ğŸ‘‰ TÃ­n hiá»‡u MUA táº¡i giÃ¡ {last['Buy']:.2f}")
        elif not np.isnan(last['Sell']):
            st.error(f"ğŸ‘ˆ TÃ­n hiá»‡u BÃN táº¡i giÃ¡ {last['Sell']:.2f}")
        else:
            st.info("â³ ChÆ°a cÃ³ tÃ­n hiá»‡u rÃµ rÃ ng.")
    else:
        st.warning("âš ï¸ KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u tá»« Finnhub. Kiá»ƒm tra láº¡i mÃ£ cá»• phiáº¿u hoáº·c API Key.")
else:
    st.info("ğŸ” d1l0omhr01qt8foqo9fgd1l0omhr01qt8foqo9g0")
   
